name: PR Auto Fix and Check

on:
  pull_request:
    branches: [main, develop]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.14.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Prettier format
        id: prettier
        run: |
          pnpm format
          if [[ -n $(git diff --name-only) ]]; then
            echo "formatted=true" >> $GITHUB_OUTPUT
            echo "### âœ¨ Prettierãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¾ã—ãŸ:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            git diff --name-only >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "formatted=false" >> $GITHUB_OUTPUT
            echo "### âœ… ã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ã§ã™" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run ESLint check
        id: eslint-check
        run: |
          if pnpm lint; then
            echo "lint_errors=false" >> $GITHUB_OUTPUT
            echo "### âœ… ESLintã‚¨ãƒ©ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          else
            echo "lint_errors=true" >> $GITHUB_OUTPUT
            echo "### âš ï¸ ESLintã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "è‡ªå‹•ä¿®æ­£ã‚’è©¦ã¿ã¦ã„ã¾ã™..." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run ESLint auto-fix
        id: eslint-fix
        if: steps.eslint-check.outputs.lint_errors == 'true'
        run: |
          pnpm lint:fix
          if [[ -n $(git diff --name-only) ]]; then
            echo "fixed=true" >> $GITHUB_OUTPUT
            echo "### ğŸ”§ ESLintè‡ªå‹•ä¿®æ­£ã‚’é©ç”¨ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿®æ­£ã•ã‚Œã¾ã—ãŸ:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            git diff --name-only >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "fixed=false" >> $GITHUB_OUTPUT
          fi

          # Check if there are still errors after auto-fix
          if pnpm lint; then
            echo "remaining_errors=false" >> $GITHUB_OUTPUT
            echo "### âœ… ã™ã¹ã¦ã®ESLintã‚¨ãƒ©ãƒ¼ãŒè‡ªå‹•ä¿®æ­£ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "remaining_errors=true" >> $GITHUB_OUTPUT
            echo "### âŒ ä¸€éƒ¨ã®ESLintã‚¨ãƒ©ãƒ¼ã¯è‡ªå‹•ä¿®æ­£ã§ãã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "ãƒ­ãƒ¼ã‚«ãƒ«ã§ \`pnpm lint\` ã‚’å®Ÿè¡Œã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã€æ‰‹å‹•ã§ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit and push changes
        if: steps.prettier.outputs.formatted == 'true' || steps.eslint-fix.outputs.fixed == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨ãƒªãƒ³ãƒˆã®å•é¡Œã‚’è‡ªå‹•ä¿®æ­£"
          git push

      - name: Comment PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const output = [];
            const prettierFormatted = '${{ steps.prettier.outputs.formatted }}' === 'true';
            const eslintErrors = '${{ steps.eslint-check.outputs.lint_errors }}' === 'true';
            const eslintFixed = '${{ steps.eslint-fix.outputs.fixed }}' === 'true';
            const remainingErrors = '${{ steps.eslint-fix.outputs.remaining_errors }}' === 'true';

            if (prettierFormatted || eslintFixed) {
              output.push('## ğŸ¤– è‡ªå‹•ä¿®æ­£ãƒ¬ãƒãƒ¼ãƒˆ');
              output.push('');
              
              if (prettierFormatted) {
                output.push('### âœ¨ Prettier');
                output.push('ã‚³ãƒ¼ãƒ‰ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒè‡ªå‹•çš„ã«é©ç”¨ã•ã‚Œã¾ã—ãŸã€‚');
                output.push('');
              }
              
              if (eslintFixed) {
                output.push('### ğŸ”§ ESLint');
                output.push('ä¸€éƒ¨ã®ESLintã®å•é¡ŒãŒè‡ªå‹•çš„ã«ä¿®æ­£ã•ã‚Œã¾ã—ãŸã€‚');
                output.push('');
              }
              
              output.push('**å¤‰æ›´ã¯è‡ªå‹•çš„ã«ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã€ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã—ãŸã€‚**');
              output.push('');
            }

            if (remainingErrors) {
              output.push('### âŒ æ‰‹å‹•ä¿®æ­£ãŒå¿…è¦ã§ã™');
              output.push('ä¸€éƒ¨ã®ESLintã‚¨ãƒ©ãƒ¼ã¯è‡ªå‹•çš„ã«ä¿®æ­£ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
              output.push('ãƒ­ãƒ¼ã‚«ãƒ«ã§ `pnpm lint` ã‚’å®Ÿè¡Œã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã€æ‰‹å‹•ã§ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚');
              output.push('');
            } else if (!prettierFormatted && !eslintErrors) {
              output.push('## âœ… ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸ');
              output.push('ã‚³ãƒ¼ãƒ‰ã¯é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ãŠã‚Šã€ãƒªãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ã‚‚ã‚ã‚Šã¾ã›ã‚“ï¼');
            }

            if (output.length > 0) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: output.join('\n')
              });
            }

      - name: Fail if unfixable errors remain
        if: steps.eslint-fix.outputs.remaining_errors == 'true'
        run: |
          echo "::error::ä¸€éƒ¨ã®ESLintã‚¨ãƒ©ãƒ¼ã¯è‡ªå‹•çš„ã«ä¿®æ­£ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"
          exit 1
